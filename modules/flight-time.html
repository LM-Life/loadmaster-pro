<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no">
  <title>Loadmaster Pro | Flight Time</title>
  <link rel="stylesheet" href="../style.css">
  <style>
    .container {
      max-width: 820px;
      margin: 0 auto;
      padding: 10px 12px;
    }

    .home-button {
      display: inline-flex;
      align-items: center;
      gap: 8px;
      text-decoration: none;
      -webkit-tap-highlight-color: transparent;
      margin: 4px 0 10px;
    }

    .module-title {
      margin: 0 0 12px;
      font-size: 30px;
      letter-spacing: .08em;
      text-transform: uppercase;
      font-weight: 950;
      line-height: 1.05;
    }

    .card {
      border: 1px solid rgba(255, 255, 255, 0.14);
      border-radius: 16px;
      padding: 10px;
      background: rgba(255, 255, 255, 0.04);
      box-shadow: 0 10px 26px rgba(0, 0, 0, 0.30);
    }

    .grid-2 {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 10px;
    }

    .time-grid {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 10px;
    }

    /* Keep 2 columns on iPhone to reduce scroll; fall back only on very narrow screens */
    @media (max-width: 340px) {
      .time-grid {
        grid-template-columns: 1fr;
      }
    }

    label {
      display: block;
      font-weight: 900;
      margin: 0 0 4px;
      letter-spacing: .02em;
    }

    input,
    select,
    button {
      width: 100%;
      padding: 10px 12px;
      border-radius: 12px;
      border: 1px solid rgba(255, 255, 255, 0.16);
      background: rgba(10, 14, 20, 0.35);
      color: #fff;
      font-size: 16px;
      box-sizing: border-box;
      min-height: 44px;
    }

    button {
      font-weight: 950;
      cursor: pointer;
    }

    .time-row {
      display: flex;
      flex-direction: column;
      gap: 8px;
    }

    .time-row input {
      width: 100%;
    }

    .mini {
      flex: 0 0 auto;
      width: 100%;
      min-width: 100%;
      padding: 10px 10px;
      font-weight: 950;
    }

    .zulu-line {
      margin-top: 8px;
      font-size: 14px;
      opacity: .92;
    }

    .result-card {
      margin-top: 10px;
      border-radius: 16px;
      border: 1px solid rgba(255, 255, 255, 0.14);
      background: rgba(10, 14, 20, 0.52);
      padding: 10px;
    }

    .result-top {
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 10px;
      margin-bottom: 8px;
    }

    .result-top .label {
      font-weight: 950;
      letter-spacing: .10em;
      text-transform: uppercase;
      opacity: .9;
      font-size: 12px;
    }

    .badge {
      display: inline-block;
      padding: 2px 10px;
      border-radius: 999px;
      border: 1px solid rgba(255, 255, 255, 0.18);
      font-size: 12px;
      opacity: .9;
      white-space: nowrap;
    }

    .result-main {
      font-size: 44px;
      font-weight: 950;
      line-height: 1;
      margin: 0 0 6px;
    }

    .result-sub {
      font-size: 13px;
      opacity: .92;
      line-height: 1.25;
    }

    .helper {
      margin-top: 6px;
      font-size: 12.5px;
      opacity: .92;
      line-height: 1.3;
    }

    .error {
      opacity: 1;
      font-weight: 950;
    }

    .actions {
      margin-top: 10px;
      border-top: 1px solid rgba(255, 255, 255, 0.10);
      padding-top: 10px;
    }

    .action-grid {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 10px;
    }

    .action-grid+.action-grid {
      margin-top: 10px;
    }

    @media (max-width: 340px) {
      .action-grid {
        grid-template-columns: 1fr;
      }
    }

    details.conv {
      margin-top: 10px;
    }

    details.conv summary {
      cursor: pointer;
      list-style: none;
      padding: 9px 12px;
      border-radius: 12px;
      border: 1px solid rgba(255, 255, 255, 0.14);
      background: rgba(255, 255, 255, 0.05);
      font-weight: 950;
    }

    details.conv summary::-webkit-details-marker {
      display: none;
    }

    details.conv .conv-body {
      padding: 10px 4px 2px;
      font-size: 13px;
      opacity: .92;
      line-height: 1.35;
    }

    /* iPhone tighten */
    @media (max-width: 430px) {
      .module-title {
        font-size: 28px;
        margin-bottom: 10px;
      }

      .card {
        padding: 10px;
      }

      input,
      select,
      button {
        padding: 10px 12px;
      }

      .result-main {
        font-size: 42px;
      }

      .mini {
        min-width: 78px;
      }
    }
  
    /* --- Compact spacing tweaks (v3) --- */
    .module-title { margin: 4px 0 10px !important; }
    .card { padding: 8px 10px !important; }
    .time-grid { gap: 10px !important; }
    .btn-grid { gap: 10px !important; margin-top: 10px !important; }
    .result-card { padding: 10px 12px 10px !important; }
    .result-card .details { margin-top: 8px !important; }
    .result-card .legs { margin-top: 8px !important; }

</style>
</head>
<body>
  <div class="container">
    <a class="home-button" href="../index.html">üè† Home</a>
    <h1 class="module-title">FLIGHT TIME</h1>
    <div class="card">
      <div class="time-grid">
        <div>
          <label for="startTime">Takeoff (Z)</label>
          <div class="time-row">
            <input id="startTime" type="text" inputmode="numeric" pattern="^([01]\d|2[0-3]):[0-5]\d$"
              placeholder="HH:MM (24h Z)" value="12:00" />
            <button class="mini" type="button" onclick="setNowZ('startTime')"
              aria-label="Set Takeoff to current Zulu time" class="mini">Now (Z)</button>
          </div>
        </div>
        <div>
          <label for="endTime">Landing (Z)</label>
          <div class="time-row">
            <input id="endTime" type="text" inputmode="numeric" pattern="^([01]\d|2[0-3]):[0-5]\d$"
              placeholder="HH:MM (24h Z)" value="14:55" />
            <button class="mini" type="button" onclick="setNowZ('endTime')"
              aria-label="Set Landing to current Zulu time" class="mini">Now (Z)</button>
          </div>
          <div class="actions" role="region" aria-label="Actions">
            <div class="action-grid">
              <button type="button" onclick="calc()">Calculate</button>
              <button type="button" onclick="clearAll()">Clear</button>
            </div>
            <div class="action-grid">
              <button type="button" onclick="addLeg()">Add Leg</button>
              <button type="button" onclick="resetLegs()">Reset Legs</button>
            </div>
          </div>
        </div>
        <div id="zuluClock" class="zulu-line">Zulu: --:--:--Z</div>
        <div class="result-card" aria-label="Results">
          <div class="result-top">
            <div class="label">Flight Time</div>
            <span class="badge">Zulu ‚Ä¢ HH.MM</span>
          </div>
          <div id="resultMain" class="result-main">‚Äî</div>
          <div id="resultSub" class="result-sub"></div>
          <div id="details" class="result-sub" style="margin-top:6px;"></div>
          <div id="note" class="result-sub"></div>
          <div id="legs" class="result-sub" style="margin-top:8px;"></div>
          <div id="rollover" class="result-sub" style="margin-top:6px;font-weight:950;"></div>
        </div>
        <div class="helper"><span class="badge">Time Format</span> 24‚Äëhour clock (HH:MM) in Zulu only.</div>
        <details class="conv">
          <summary>Minutes ‚Üí Decimal Conversion (TO table)</summary>
          <div class="conv-body subtle">
              1‚Äì2 = .0
              3‚Äì8 = .1
             9‚Äì14 = .2
            15‚Äì20 = .3
            21‚Äì26 = .4
            27‚Äì33 = .5
            34‚Äì39 = .6
            40‚Äì45 = .7
            46‚Äì51 = .8
            52‚Äì57 = .9
            58‚Äì60 = Next hour
          </div>
        </details>
      </div>
    </div>
  </div>
  </div>
  
<script>
(() => {
  'use strict';

  // --- Minute ‚Üí Decimal conversion table (from TO photo) ---
  // This matches the table we used earlier: ranges map minute buckets to decimals.
  const MINUTE_RANGES = [
    { min: 0,  max: 2,  dec: 0.0 },
    { min: 3,  max: 8,  dec: 0.1 },
    { min: 9,  max: 14, dec: 0.2 },
    { min: 15, max: 20, dec: 0.3 },
    { min: 21, max: 26, dec: 0.4 },
    { min: 27, max: 32, dec: 0.5 },
    { min: 33, max: 38, dec: 0.6 },
    { min: 39, max: 45, dec: 0.7 },
    { min: 46, max: 51, dec: 0.8 },
    { min: 52, max: 57, dec: 0.9 },
    { min: 58, max: 59, dec: 1.0 },
  ];

  const $ = (id) => document.getElementById(id);

  const els = {
    start: $('startTime'),
    end: $('endTime'),
    nowStart: $('nowStart'),
    nowEnd: $('nowEnd'),
    zulu: $('zuluClock'),

    resultMain: $('resultMain'),
    resultSub: $('resultSub'),
    details: $('details'),
    legs: $('legs'),
    rollover: $('rollover'),

    btnCalc: $('btnCalc'),
    btnClear: $('btnClear'),
    btnAddLeg: $('btnAddLeg'),
    btnResetLegs: $('btnResetLegs'),
  };

  // --- State ---
  let legs = [];
  let lastCalc = null; // string like "2.9"
  let lastElapsed = null; // "2:55"
  let lastExplain = null; // "Minutes 55 ‚Üí 52‚Äì57 = .9"
  let lastRolled = false;

  function loadState() {
    try {
      const raw = localStorage.getItem('flightTimeLegs_v1');
      legs = raw ? JSON.parse(raw) : [];
      if (!Array.isArray(legs)) legs = [];
    } catch { legs = []; }
  }

  function saveState() {
    try {
      localStorage.setItem('flightTimeLegs_v1', JSON.stringify(legs));
    } catch {}
  }

  function pad2(n) { return String(n).padStart(2, '0'); }

  function getZuluHHMM() {
    const d = new Date();
    return `${pad2(d.getUTCHours())}:${pad2(d.getUTCMinutes())}`;
  }

  function getZuluClock() {
    const d = new Date();
    return `${pad2(d.getUTCHours())}:${pad2(d.getUTCMinutes())}:${pad2(d.getUTCSeconds())}Z`;
  }

  function setNowZ(targetId) {
    const el = $(targetId);
    if (!el) return;
    el.value = getZuluHHMM();
    autoFormatTime(el);
    // Recalc if we already had a result displayed (nice UX)
    if (lastCalc !== null) calc();
  }

  function autoFormatTime(input) {
    // Keeps "HH:MM" and 24-hr.
    let v = (input.value || '').trim();
    if (!v) return;
    // Accept 4 digits: 0631 ‚Üí 06:31
    if (/^\d{4}$/.test(v)) v = v.slice(0,2) + ':' + v.slice(2);
    // Accept H:MM
    if (/^\d{1}:\d{2}$/.test(v)) v = '0' + v;
    // Accept HHMM (3 digits) like 631 ‚Üí 06:31
    if (/^\d{3}$/.test(v)) v = '0' + v[0] + ':' + v.slice(1);
    // Final validation
    const m = v.match(/^(\d{2}):(\d{2})$/);
    if (!m) return;
    const hh = Number(m[1]), mm = Number(m[2]);
    if (hh < 0 || hh > 23 || mm < 0 || mm > 59) return;
    input.value = `${pad2(hh)}:${pad2(mm)}`;
  }

  function minutesToDecimal(mins) {
    const r = MINUTE_RANGES.find(x => mins >= x.min && mins <= x.max);
    if (!r) return { dec: 0.0, label: '.0', range: '0‚Äì2' };
    const label = (r.dec === 1.0) ? '1.0' : `.${String(r.dec).split('.')[1] || '0'}`;
    return { dec: r.dec, label, range: `${r.min}‚Äì${r.max}` };
  }

  function diffMinutes(startHHMM, endHHMM) {
    const [sh, sm] = startHHMM.split(':').map(Number);
    const [eh, em] = endHHMM.split(':').map(Number);
    const start = sh * 60 + sm;
    const end = eh * 60 + em;
    if (Number.isNaN(start) || Number.isNaN(end)) return null;

    let delta = end - start;
    let rolled = false;
    if (delta < 0) { delta += 24 * 60; rolled = true; }
    return { delta, rolled };
  }

  function formatElapsed(totalMins) {
    const h = Math.floor(totalMins / 60);
    const m = totalMins % 60;
    return `${h}:${pad2(m)}`;
  }

  function render() {
    // Main result
    els.resultMain.textContent = lastCalc ?? '0.0';
    els.resultSub.textContent = lastElapsed ? `Elapsed: ${lastElapsed} (H:MM)` : `Elapsed: 0:00 (H:MM)`;

    // Details
    if (lastExplain) {
      els.details.textContent = lastExplain;
    } else {
      els.details.textContent = 'Minutes ‚Üí Decimal';
    }

    // Rollover notice
    els.rollover.style.display = lastRolled ? 'block' : 'none';

    // Legs list (Leg 1, Leg 2...)
    const lines = [];
    for (let i = 0; i < legs.length; i++) {
      lines.push(`Leg ${i + 1}: ${legs[i]}`);
    }
    // Show next leg preview (current calculation), so paperwork is easy to read
    const nextIdx = legs.length + 1;
    const nextVal = (lastCalc && lastCalc !== '0.0') ? lastCalc : '‚Äî';
    lines.push(`Leg ${nextIdx}: ${nextVal}`);

    els.legs.innerHTML = lines.join('<br>');
  }

  function clearAll() {
    els.start.value = '';
    els.end.value = '';
    lastCalc = null;
    lastElapsed = null;
    lastExplain = null;
    lastRolled = false;
    render();
  }

  function resetLegs() {
    legs = [];
    saveState();
    render();
  }

  function addLeg() {
    // Only add if we have a valid calculation (not placeholder)
    if (!lastCalc || lastCalc === '0.0') return;
    legs.push(lastCalc);
    saveState();
    // After adding, "freeze" that leg and reset lastCalc so next leg starts blank
    lastCalc = null;
    lastElapsed = null;
    lastExplain = null;
    lastRolled = false;
    render();
  }

  function calc() {
    autoFormatTime(els.start);
    autoFormatTime(els.end);

    const s = (els.start.value || '').trim();
    const e = (els.end.value || '').trim();

    // Require both to calculate
    if (!/^\d{2}:\d{2}$/.test(s) || !/^\d{2}:\d{2}$/.test(e)) {
      lastCalc = null;
      lastElapsed = null;
      lastExplain = null;
      lastRolled = false;
      render();
      return;
    }

    const d = diffMinutes(s, e);
    if (!d) return;

    const totalMins = d.delta;
    lastRolled = d.rolled;

    const elapsed = formatElapsed(totalMins);
    const mins = totalMins % 60;
    const hours = Math.floor(totalMins / 60);

    const conv = minutesToDecimal(mins);

    // The TO table treats 58‚Äì59 as +1.0, which increments the hour.
    let decHours = hours + conv.dec;
    if (conv.dec === 1.0) decHours = hours + 1.0;

    // Keep one decimal place (e.g., 2.9)
    lastCalc = decHours.toFixed(1);
    lastElapsed = elapsed;
    lastExplain = `Minutes ${mins} ‚Üí ${conv.range} = ${conv.label}`;

    render();
  }

  function tickZulu() {
    els.zulu.textContent = `Current Zulu: ${getZuluClock()}`;
  }

  function wire() {
    // Prevent accidental form submits (if any)
    [els.nowStart, els.nowEnd, els.btnCalc, els.btnClear, els.btnAddLeg, els.btnResetLegs].forEach(b => {
      if (b) b.setAttribute('type', 'button');
    });

    els.nowStart?.addEventListener('click', () => setNowZ('startTime'));
    els.nowEnd?.addEventListener('click', () => setNowZ('endTime'));
    els.btnCalc?.addEventListener('click', calc);
    els.btnClear?.addEventListener('click', clearAll);
    els.btnAddLeg?.addEventListener('click', addLeg);
    els.btnResetLegs?.addEventListener('click', resetLegs);

    // Auto-format on blur
    els.start?.addEventListener('blur', () => autoFormatTime(els.start));
    els.end?.addEventListener('blur', () => autoFormatTime(els.end));
  }

  // Init
  loadState();
  wire();
  tickZulu();
  setInterval(tickZulu, 1000);
  render();
})();
</script>

</body>

</html>
