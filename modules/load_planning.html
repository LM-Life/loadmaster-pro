<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Loadmaster Pro ‚Äî Load Planning</title>
  <!-- Uses your shared styles if present; safe to omit if you don't have styles.css -->
  <link rel="stylesheet" href="../style.css" />
  <script src="../common.js" defer></script>
</head>
<body>
  <button type="button" class="home-button">üè† Home</button>
  
  <h1>Load Planning</h1>

  <!-- Operating (Basic Aircraft) -->
  <div class="section">
    <h3>Operating (Basic Aircraft)</h3>
    <div class="grid-2">
      <div>
        <label for="opWeight">Operating Weight (lbs)</label>
        <input type="text" id="opWeight" inputmode="numeric" pattern="[0-9]*" placeholder="e.g., 270000">
      </div>
      <div>
        <label for="opMom10k">Operating MOM / 10,000</label>
        <input type="text" id="opMom10k" inputmode="numeric" pattern="[0-9]*" placeholder="e.g., 21500">
      </div>
    </div>
    <p class="muted" style="margin:.4rem 0 0">Tip: If you only know Operating CG, multiply by Operating Weight and divide by 10,000 to get MOM/10,000.</p>
  </div>

  <!-- Payload items -->
  <div class="section">
    <h3>Payload Items</h3>
    <p class="muted">Enter Left, <b>Center</b>, Right, and Station. Weight auto-sums (Left + Center + Right). MOM/10,000 is computed.</p>
    <table id="payloadTable">
      <thead>
        <tr>
          <th>#</th>
          <th>Left (lbs)</th>
          <th>Center (lbs)</th>
          <th>Right (lbs)</th>
          <th>Station (in)</th>
          <th>Weight (lbs)</th>
          <th>MOM / 10,000</th>
          <th>Actions</th>
        </tr>
      </thead>
      <tbody id="payloadBody"></tbody>
      <tfoot>
        <tr>
          <th colspan="5" style="text-align:right">Totals:</th>
          <th id="totalWeight">0</th>
          <th id="totalMom10k">0</th>
          <th></th>
        </tr>
      </tfoot>
    </table>
    <div style="margin-top:.75rem; display:flex; gap:.5rem; flex-wrap:wrap;">
      <button onclick="addRow()">+ Add Row</button>
      <button class="btn-danger" onclick="clearAll()">Clear All</button>
    </div>
  </div>

  <!-- Computed -->
  <div class="section">
    <h3>Results</h3>
    <div class="grid-2">
      <div>
        <label>Load CB (in)</label>
        <input type="text" id="loadCB" readonly>
      </div>
      <div>
        <label>Total Payload (lbs)</label>
        <input type="text" id="payloadTotal" readonly>
      </div>
      <div>
        <label>Zero Fuel CG (in)</label>
        <input type="text" id="zfCG" readonly>
      </div>
      <div>
        <label>Zero Fuel %MAC</label>
        <input type="text" id="zfMAC" readonly>
      </div>
    </div>
    <div id="limitsBadge" style="margin-top:.35rem"></div>
  </div>

  <!-- Envelope (Non-E/R) -->
  <div class="section">
    <h3>Cargo Weight Loading Envelope ‚Äî Non-E/R</h3>
    <p class="muted">Checks <b>Load CB</b> against the Non-E/R envelope. Paste anchor points from the TO as CSV (<code>payload,fwdFS,aftFS</code>). Linear interpolation between points.</p>

    <div class="grid-3">
      <div>
        <label for="envPayload">Payload to Check (auto-filled)</label>
        <input type="text" id="envPayload" readonly>
      </div>
      <div>
        <label for="envFwd">Forward Limit (FS)</label>
        <input type="text" id="envFwd" readonly>
      </div>
      <div>
        <label for="envAft">Aft Limit (FS)</label>
        <input type="text" id="envAft" readonly>
      </div>
    </div>

    <div id="envBadge" style="margin-top:.35rem"></div>

    <h4 style="margin:.75rem 0 .3rem">Envelope Points</h4>
    <textarea id="envCSV" spellcheck="false" class="muted" placeholder="Example:
45000,616,945
# Add more lines here from the TO chart"></textarea>
    <div style="margin-top:.5rem; display:flex; gap:.5rem; flex-wrap:wrap;">
      <button onclick="loadEnvelope()">Load/Update Envelope</button>
      <button onclick="resetEnvelope()">Reset to Example</button>
    </div>
  </div>

  <script>
    // Constants
    const LEMAC = 793.6;     // in
    const MAC   = 309.5;     // in

    // Rounding helpers (whole number, 1 decimal)
    const r0 = n => Math.round(Number(n)||0);
    const r1 = n => Math.round((Number(n)||0)*10)/10;

    // Elements
    const tbody = document.getElementById('payloadBody');
    const totalWeightEl = document.getElementById('totalWeight');
    const totalMom10kEl = document.getElementById('totalMom10k');

    const loadCBEl   = document.getElementById('loadCB');
    const zfCGEl     = document.getElementById('zfCG');
    const zfMACEl    = document.getElementById('zfMAC');
    const payloadTotalEl = document.getElementById('payloadTotal');

    const opWeightEl = document.getElementById('opWeight');
    const opMom10kEl = document.getElementById('opMom10k');

    function goHome(){ window.location.href = "../index.html"; }

    function parseNum(val){
      if(typeof val!=='string') return Number(val)||0;
      return Number(val.replace(/,/g,''))||0;
    }

    // Build a new table row (with CENTER column)
    function newRow(index){
      const tr = document.createElement('tr');
      tr.innerHTML = `
        <td class="row-index">${index}</td>
        <td><input type="text" inputmode="numeric" pattern="[0-9]*"   class="inp-left"    placeholder="0"></td>
        <td><input type="text" inputmode="numeric" pattern="[0-9]*"   class="inp-center"  placeholder="0"></td>
        <td><input type="text" inputmode="numeric" pattern="[0-9]*"   class="inp-right"   placeholder="0"></td>
        <td><input type="text" inputmode="numeric" pattern="[0-9.]*" class="inp-station" placeholder="0"></td>
        <td class="out-weight">0</td>
        <td class="out-mom10k">0</td>
        <td class="row-actions"><button type="button" onclick="removeRow(this)">üóë</button></td>
      `;
      tr.querySelectorAll('input').forEach(inp => inp.addEventListener('input', recalc));
      return tr;
    }

    function addRow(){ tbody.appendChild(newRow(tbody.children.length+1)); recalc(); }
    function removeRow(btn){ const tr=btn.closest('tr'); if(tr){ tr.remove(); renumberRows(); recalc(); } }
    function renumberRows(){ [...tbody.querySelectorAll('.row-index')].forEach((c,i)=>c.textContent=i+1); }

    function clearAll(){
      tbody.innerHTML=''; addRow();
      opWeightEl.value=''; opMom10kEl.value='';
      recalc();
    }

    // Envelope handling
    let envelopePts = [];
    function seedEnvelope(){
      envelopePts = [{ w: 45000, fwd: 616, aft: 945 }];
      document.getElementById('envCSV').value = "45000,616,945\n";
    }
    function loadEnvelope(){
      const txt = document.getElementById('envCSV').value || '';
      const lines = txt.split(/\r?\n/).map(s=>s.trim()).filter(Boolean).filter(s=>!s.startsWith('#'));
      const parsed = [];
      for(const line of lines){
        const [wS,fS,aS] = line.split(/,\s*/); // trims simple spaces after commas
        const w = Number(wS), f = Number(fS), a = Number(aS);
        if(Number.isFinite(w) && Number.isFinite(f) && Number.isFinite(a)) parsed.push({w,fwd:f,aft:a});
      }
      parsed.sort((a,b)=>a.w-b.w);
      if(parsed.length<1){ alert("No valid points found. Use: payload,fwdFS,aftFS"); return; }
      envelopePts = parsed; recalc();
    }
    function resetEnvelope(){ seedEnvelope(); recalc(); }

    function interpolateEnvelope(payload){
      if(envelopePts.length===0) return null;
      if(payload <= envelopePts[0].w) return { fwd: envelopePts[0].fwd, aft: envelopePts[0].aft };
      if(payload >= envelopePts[envelopePts.length-1].w) return { fwd: envelopePts[envelopePts.length-1].fwd, aft: envelopePts[envelopePts.length-1].aft };
      for(let i=0;i<envelopePts.length-1;i++){
        const p0=envelopePts[i], p1=envelopePts[i+1];
        if(payload>=p0.w && payload<=p1.w){
          const t=(payload-p0.w)/(p1.w-p0.w);
          return { fwd: p0.fwd + t*(p1.fwd-p0.fwd), aft: p0.aft + t*(p1.aft-p0.aft) };
        }
      }
      return null;
    }

    function recalc(){
      let totalWeight=0, totalMom10k=0;

      [...tbody.querySelectorAll('tr')].forEach(tr=>{
        const left   = parseNum(tr.querySelector('.inp-left').value);
        const center = parseNum(tr.querySelector('.inp-center').value);
        const right  = parseNum(tr.querySelector('.inp-right').value);
        const station= parseNum(tr.querySelector('.inp-station').value);

        const weight = r0(left + center + right);
        const mom10k = r0((weight * station) / 10000);

        tr.querySelector('.out-weight').textContent = weight.toLocaleString();
        tr.querySelector('.out-mom10k').textContent = mom10k.toLocaleString();

        totalWeight += weight;
        totalMom10k += mom10k;
      });

      totalWeightEl.textContent = totalWeight.toLocaleString();
      totalMom10kEl.textContent = totalMom10k.toLocaleString();
      payloadTotalEl.value = totalWeight ? totalWeight.toLocaleString() : '';

      const totalMom = totalMom10k * 10000;
      const loadCB   = totalWeight>0 ? totalMom/totalWeight : 0;
      loadCBEl.value = totalWeight>0 ? r1(loadCB).toFixed(1) : '';

      const opW   = parseNum(opWeightEl.value);
      const opM10 = parseNum(opMom10kEl.value);
      const opMom = opM10 * 10000;

      const zfW   = opW + totalWeight;
      const zfMom = opMom + totalMom;
      const zfCG  = zfW>0 ? zfMom / zfW : 0;

      zfCGEl.value  = zfW>0 ? r1(zfCG).toFixed(1) : '';
      const macPct  = zfW>0 ? ((zfCG - LEMAC) / MAC) * 100 : 0;
      zfMACEl.value = zfW>0 ? r1(macPct).toFixed(1) : '';

      // Envelope check
      const envPayloadEl = document.getElementById('envPayload');
      const envFwdEl     = document.getElementById('envFwd');
      const envAftEl     = document.getElementById('envAft');
      const envBadge     = document.getElementById('envBadge');

      envPayloadEl.value = totalWeight>0 ? r0(totalWeight).toLocaleString() : '';

      if(totalWeight>0 && envelopePts.length>0){
        const limits = interpolateEnvelope(totalWeight);
        if(limits){
          const fwd = r1(limits.fwd), aft = r1(limits.aft);
          envFwdEl.value = fwd.toFixed(1);
          envAftEl.value = aft.toFixed(1);

          if(loadCB===0){
            envBadge.innerHTML = `<span class="pill warn">No Load CB yet</span>`;
          } else if(loadCB < fwd){
            envBadge.innerHTML = `<span class="pill bad">FORWARD of limit ‚Äî Load CB ${r1(loadCB).toFixed(1)} &lt; FS ${fwd.toFixed(1)}</span>`;
          } else if(loadCB > aft){
            envBadge.innerHTML = `<span class="pill bad">AFT of limit ‚Äî Load CB ${r1(loadCB).toFixed(1)} &gt; FS ${aft.toFixed(1)}</span>`;
          } else {
            envBadge.innerHTML = `<span class="pill ok">WITHIN ENVELOPE ‚Äî Load CB ${r1(loadCB).toFixed(1)} between FS ${fwd.toFixed(1)} and FS ${aft.toFixed(1)}</span>`;
          }
        } else {
          envFwdEl.value = ''; envAftEl.value = '';
          envBadge.innerHTML = `<span class="pill warn">Payload outside your entered envelope points ‚Äî add more data</span>`;
        }
      } else {
        envFwdEl.value = ''; envAftEl.value = '';
        envBadge.innerHTML = '';
      }
    }

    // Listeners
    ['opWeight','opMom10k'].forEach(id => {
      document.getElementById(id).addEventListener('input', recalc);
    });

    // Init
    function init(){ seedEnvelope(); addRow(); addRow(); addRow(); recalc(); }
    init();
  </script>
</body>
</html>
