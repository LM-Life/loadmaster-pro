<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Restraint Calculator</title>
  <link rel="stylesheet" href="../style.css" />
  <link rel="stylesheet" href="../style_patch.css" />
  <script src="../common.js" defer></script>
</head>
<body>
  <button onclick="goHome()" class="home-button">üè† Home</button>

  <h1>Restraint Calculator</h1>

  <!-- Required Restraint -->
  <label for="cargoWeight">Cargo Weight (lbs):</label>
  <input id="cargoWeight" class="form-control" inputmode="numeric" pattern="[0-9]*" placeholder="e.g., 12000" />

  <button onclick="calculateRestraint()">Calculate Required Restraint</button>
  <div id="result" class="card mt-2"></div>

  <hr class="divider" />

  <!-- Actual Restraint -->
  <h2>Actual Restraint Calculator</h2>

  <label for="restraintDirection">Direction:</label>
<select id="restraintDirection" class="form-control">
  <option value="FWD">FWD</option>
  <option value="AFT">AFT</option>
  <option value="LAT-LEFT">LAT ‚Äì LEFT</option>
  <option value="LAT-RIGHT">LAT ‚Äì RIGHT</option>
  <option value="VERT">VERT</option>
</select>

  <div id="latSideRow" class="mt-1" style="display:none;">
    <label for="latSide">Lateral Side:</label>
    <select id="latSide" class="form-control">
      <option value="LEFT">LEFT</option>
      <option value="RIGHT">RIGHT</option>
    </select>
  </div>

  <label for="actualLength">Actual Length (in):</label>
  <input id="actualLength" class="form-control" inputmode="numeric" pattern="[0-9]*" placeholder="e.g., 100" />

  <label for="effectiveLength">Effective Length (in):</label>
  <input id="effectiveLength" class="form-control" inputmode="numeric" pattern="[0-9]*" placeholder="e.g., 80" />

  <label for="restraintFactor">Restraint Factor:</label>
  <select id="restraintFactor" class="form-control">
    <option value="5000">5,000 lbs</option>
    <option value="7500">7,500 lbs</option>
    <option value="10000">10,000 lbs</option>
    <option value="25000" selected>25,000 lbs</option>
    <option value="custom">Custom‚Ä¶</option>
  </select>

  <!-- Hidden until "Custom‚Ä¶" is selected -->
  <input
    type="text"
    inputmode="numeric"
    pattern="[0-9]*"
    id="restraintFactorCustom"
    class="form-control"
    placeholder="Enter custom factor in lbs (e.g., 8000)"
    style="display:none; margin-top:.5rem;"
  />
  <div id="factorError" style="color:#f66; font-size:.95rem; display:none;"></div>

  <div class="center mt-1">
    <button id="multiplierToggle" class="btn-outline" onclick="toggleMultiplier()">√ó2 OFF</button>
  </div>

  <button onclick="calculateActualRestraint()">Add Actual Restraint</button>
  <button class="btn-danger" onclick="clearAll()">Clear All</button>

  <script>
    let requiredText = "";
    let requiredRestraint = {
      FWD: 0,
      AFT: 0,
      LAT: 0,   // requirement per side
      VERT: 0
    };
    
    let totalRestraint = {
      FWD: 0,
      AFT: 0,
      "LAT-LEFT": 0,
      "LAT-RIGHT": 0,
      VERT: 0
    };
    
    let doubleMultiplier = false;

    // UI helpers
    function onDirectionChange() {
      const dir = document.getElementById("restraintDirection").value;
      document.getElementById("latSideRow").style.display = (dir === "LAT") ? "block" : "none";
    }

    function toggleMultiplier() {
      doubleMultiplier = !doubleMultiplier;
      const btn = document.getElementById("multiplierToggle");
      btn.textContent = doubleMultiplier ? "√ó2 ON" : "√ó2 OFF";
      btn.classList.toggle("active", doubleMultiplier);
    }

    // Factor selector: use custom if chosen
    function onFactorChange() {
      const sel = document.getElementById('restraintFactor').value;
      const custom = document.getElementById('restraintFactorCustom');
      const err = document.getElementById('factorError');
      custom.style.display = sel === 'custom' ? 'block' : 'none';
      if (sel !== 'custom') { custom.value = ''; err.style.display = 'none'; }
    }

    function getSelectedFactor() {
      const selVal = document.getElementById('restraintFactor').value;
      if (selVal !== 'custom') return parseFloat(selVal);

      const err = document.getElementById('factorError');
      const raw = document.getElementById('restraintFactorCustom').value.replace(/,/g,'');
      const v = parseFloat(raw);
      if (!Number.isFinite(v) || v <= 0) {
        err.textContent = 'Enter a valid custom factor (lbs).';
        err.style.display = 'block';
        return null;
      }
      err.style.display = 'none';
      return v;
    }
    
    function getRestraintFactor() {
      const sel = document.getElementById("restraintFactor")?.value || "10000";
    
      if (sel === "custom") {
        const customVal = parseFloat(document.getElementById("restraintFactorCustom")?.value);
        return Number.isFinite(customVal) && customVal > 0 ? customVal : NaN;
      }
    
      return parseFloat(sel);
    }

    function pill(ok) {
      return ok ? "‚úÖ PASS" : "‚ùå FAIL";
    }
    
    function remaining(req, actual) {
      return Math.max(req - actual, 0);
    }
    
    // LAT requirement applies to BOTH sides
    function getRequiredForDirection(dir) {
      if (!requiredRestraint) return 0;
      if (dir === "LAT-LEFT" || dir === "LAT-RIGHT") return requiredRestraint.LAT || 0;
      return requiredRestraint[dir] || 0;
    }
    
    function hasRequirementSet() {
      return (requiredRestraint.FWD + requiredRestraint.AFT + requiredRestraint.LAT + requiredRestraint.VERT) > 0;
    }
    
    function buildDisplay() {
      const reqSet = hasRequirementSet();
    
      // Build a per-direction table-style summary
      const rows = [
        { key: "FWD", label: "FWD" },
        { key: "AFT", label: "AFT" },
        { key: "LAT-LEFT", label: "LAT-LEFT" },
        { key: "LAT-RIGHT", label: "LAT-RIGHT" },
        { key: "VERT", label: "VERT" }
      ];
    
      let out = "";
      if (requiredText) out += requiredText + "\n\n";
    
      out += "Current Actual Totals:\n";
    
      rows.forEach(r => {
        const act = totalRestraint[r.key] || 0;
    
        if (!reqSet) {
          out += `${r.label}: ${act} lbs\n`;
          return;
        }
    
        const req = getRequiredForDirection(r.key);
        const ok = act >= req;
        const rem = remaining(req, act);
    
        out += `${r.label}: ${act} lbs   ${pill(ok)}   Remaining: ${rem} lbs\n`;
      });
    
      if (reqSet) {
        out += "\nNote: LAT requirement applies to each side (LEFT and RIGHT).";
      } else {
        out += "\nTip: Enter Cargo Weight and tap 'Calculate Required Restraint' to enable PASS/FAIL + Remaining.";
      }
    
      return out.trim();
    }

    function calculateRestraint() {
      const weight = parseFloat(document.getElementById("cargoWeight").value);
      if (isNaN(weight) || weight <= 0) {
        document.getElementById("result").innerHTML = "Enter a valid cargo weight.";
        return;
      }
    
      const g = { FWD: 3.0, AFT: 1.5, LAT: 1.5, VERT: 2.0 };
    
      requiredRestraint = {
        FWD: Math.round(weight * g.FWD),
        AFT: Math.round(weight * g.AFT),
        LAT: Math.round(weight * g.LAT), // per side
        VERT: Math.round(weight * g.VERT)
      };
    
      requiredText =
    `Required Restraint for ${Math.round(weight)} lbs:
    FWD:  ${requiredRestraint.FWD} lbs
    AFT:  ${requiredRestraint.AFT} lbs
    LAT:  ${requiredRestraint.LAT} lbs (each side)
    VERT: ${requiredRestraint.VERT} lbs`;
    
      document.getElementById("result").innerHTML = buildDisplay();
    }

    function calculateActualRestraint() {
      const actual = parseFloat(document.getElementById("actualLength").value);
      const effective = parseFloat(document.getElementById("effectiveLength").value);
      const factor = getRestraintFactor();
      const direction = document.getElementById("restraintDirection").value;
    
      if (isNaN(actual) || actual <= 0 || isNaN(effective) || effective <= 0) {
        document.getElementById("result").innerHTML =
          buildDisplay() + "\n\n‚ö†Ô∏è Enter valid actual and effective lengths.";
        return;
      }
    
      let value = (effective / actual) * factor;
      if (doubleMultiplier) value *= 2;
    
      value = Math.round(value);
    
      if (!(direction in totalRestraint)) {
        document.getElementById("result").innerHTML =
          buildDisplay() + "\n\n‚ö†Ô∏è Invalid direction selection.";
        return;
      }
    
      totalRestraint[direction] += value;
    
      document.getElementById("result").innerHTML = buildDisplay();
    }

      const factor = getSelectedFactor();
      if (factor === null) return; // invalid custom factor

      let value = (effective / actual) * factor;
      if (doubleMultiplier) value *= 2;
      value = Math.round(value);

      if (direction === "LAT") {
        // LEFT/RIGHT is informational; totals roll into LAT
        totalRestraint.LAT += value;
      } else {
        totalRestraint[direction] += value;
      }

      document.getElementById("result").innerHTML = displayTotals(requiredText);
    }

    function clearAll() {
      document.getElementById("cargoWeight").value = "";
      document.getElementById("actualLength").value = "";
      document.getElementById("effectiveLength").value = "";

      document.getElementById("restraintDirection").value = "FWD";
      document.getElementById("latSide").value = "LEFT";
      onDirectionChange();

      document.getElementById("restraintFactor").value = "10000";
      document.getElementById("restraintFactorCustom").value = "";
      document.getElementById("restraintFactorCustom").style.display = "none";
      document.getElementById("factorError").style.display = "none";

      totalRestraint = {
        FWD: 0,
        AFT: 0,
        "LAT-LEFT": 0,
        "LAT-RIGHT": 0,
        VERT: 0
      };
      doubleMultiplier = false;

      const tgl = document.getElementById("multiplierToggle");
      tgl.textContent = "√ó2 OFF";
      tgl.classList.remove("active");

      document.getElementById("result").innerHTML = "";
      requiredText = "";
    }

    // Init
    document.getElementById('restraintFactor').addEventListener('change', onFactorChange);
    onDirectionChange();
    onFactorChange();
  </script>
</body>
</html>
